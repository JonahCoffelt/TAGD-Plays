<!DOCTYPE html>
<html>
<head>
    <title>Web Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">

        <div class="portrait-only images-container">
            <img src="/tagd.png" alt="TAGD Logo" class="logo">
            <img id="team-image-portrait" src="" alt="Team Logo" class="team-image">
        </div>

        <!-- Controller -->
        <div class="controller-pad">
                
            <!-- Left button layout -->
            <div class="button-layout">
                <button class="arrow-button button up" id="btn-up" data-button="up">▲</button>
                <button class="arrow-button button left" id="btn-left" data-button="left">◀</button>
                <button class="arrow-button button right" id="btn-right" data-button="right">▶</button>
                <button class="arrow-button button down" id="btn-down" data-button="down">▼</button>
            </div>

            <!-- Images in between the two layouts -->
            <div class="images-container landscape-only">
                <img src="/tagd.png" alt="TAGD Logo" class="logo">
                <img id="team-image-landscape" src="" alt="Team Logo" class="team-image">
            </div>

            <!-- Right button layout -->
            <div class="button-layout">
                <button class="button up" id="btn-x" data-button="x">X</button>
                <button class="button left" id="btn-y" data-button="y">Y</button>
                <button class="button right" id="btn-a" data-button="a">A</button>
                <button class="button down" id="btn-b" data-button="b">B</button>
            </div>
        </div>

    </div>

<script>
let playerTeam = null;
let serverSessionId = null;
let lastSent = 0;
const cooldown = 200; // ms

// Disable buttons until team is assigned
document.querySelectorAll('button').forEach(btn => btn.disabled = true);
function enableButtons() {
    document.querySelectorAll('button').forEach(btn => btn.disabled = false);
}

// Set the team image
function setTeamImage(team) {
    const img1 = document.getElementById("team-image-portrait");
    if (!img1) return;
    img1.src = team === "A" ? "/luigi.png" : "/toad.png";

    const img2 = document.getElementById("team-image-landscape");
    if (!img2) return;
    img2.src = team === "A" ? "/luigi.png" : "/toad.png";
}

// Load saved playerData
const savedData = JSON.parse(localStorage.getItem("playerData") || "null");

// Ask server for team + session info
fetch('/assign-team')
    .then(res => res.json())
    .then(data => {
        serverSessionId = data.sessionId;

        if (savedData && savedData.sessionId === serverSessionId) {
            playerTeam = savedData.team;
            setTeamImage(playerTeam);
            console.log("Restored Team:", playerTeam);
        } else {
            playerTeam = data.team;
            setTeamImage(playerTeam);
            localStorage.setItem("playerData", JSON.stringify({
                team: playerTeam,
                sessionId: serverSessionId
            }));
            console.log("Assigned new Team:", playerTeam);
        }
        enableButtons();
    });

// Button press handler
// document.querySelectorAll('button').forEach(button => {
//     button.addEventListener('click', () => {
//         if (!playerTeam) return;
//         const buttonName = button.dataset.button;
//         fetch('/button-press', {
//             method: 'POST',
//             headers: { 'Content-Type': 'application/json' },
//             body: JSON.stringify({ button: buttonName, team: playerTeam })
//         });
//     });
// });
document.querySelectorAll('button').forEach(button => {
  button.addEventListener('click', () => {
    const now = Date.now();
    if (now - lastSent < cooldown) return; // ignore if too soon
    lastSent = now;

    const buttonName = button.dataset.button;
    fetch('/button-press', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ button: buttonName, team: playerTeam })
    });
  });
});


</script>
</body>
</html>